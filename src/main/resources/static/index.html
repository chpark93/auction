<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Auction Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 2rem; }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9; }
        .bid-item { padding: 5px; border-bottom: 1px solid #eee; }
        .bid-item:last-child { border-bottom: none; }
        .bid-time { font-size: 0.8em; color: #888; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">üìâ Real-time Auction Monitor</h1>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Auction ID: <strong>1</strong></span>
                    <span id="status" class="badge bg-secondary">Disconnected</span>
                </div>
                <div class="card-body">
                    <button id="connectBtn" class="btn btn-primary" onclick="connect()">Connect</button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>Disconnect</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Current Highest Bid</div>
                <div class="card-body text-center">
                    <h2 id="currentPrice" class="text-success">Waiting...</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Live Bid Feed</div>
        <div class="card-body p-0">
            <div id="messages"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;
    const auctionId = 1;
    let currentMaxPrice = 0;

    function setConnected(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        const status = document.getElementById('status');
        if (connected) {
            status.className = 'badge bg-success';
            status.textContent = 'Connected';
        } else {
            status.className = 'badge bg-secondary';
            status.textContent = 'Disconnected';
        }
    }

    function connect() {
        const socket = new SockJS('/ws-auction');
        stompClient = Stomp.over(socket);
        
        // Debug Î°úÍ∑∏ ÎÅÑÍ∏∞ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        // stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            setConnected(true);
            console.log('Connected: ' + frame);
            
            // Íµ¨ÎèÖ ÏÑ§Ï†ï (/topic/auctions/{id})
            stompClient.subscribe('/topic/auctions/' + auctionId, function (message) {
                showBid(JSON.parse(message.body));
            });
        }, function (error) {
            console.error('STOMP error:', error);
            setConnected(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        console.log("Disconnected");
    }

    function showBid(bid) {
        const messages = document.getElementById('messages');
        const item = document.createElement('div');
        item.className = 'bid-item';
        
        // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
        const time = new Date(bid.bidTime).toLocaleTimeString();
        
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>User ${bid.userId}</strong>
                <span class="text-primary fw-bold">${bid.amount.toLocaleString()} KRW</span>
            </div>
            <div class="bid-time">${time}</div>
        `;
        
        // ÏµúÏã† Î©îÏãúÏßÄÍ∞Ä ÏúÑÎ°ú Ïò§Í≤å ÌïòÎ†§Î©¥ prepend
        messages.prepend(item);
        
        // ÌòÑÏû¨Í∞Ä Í∞±Ïã† (Îçî ÎÜíÏùÄ Í∞ÄÍ≤©Ïù¥ ÏôîÏùÑ ÎïåÎßå)
        if (bid.amount > currentMaxPrice) {
            currentMaxPrice = bid.amount;
            const priceEl = document.getElementById('currentPrice');
            priceEl.textContent = bid.amount.toLocaleString() + ' KRW';
            
            // Highlight effect
            priceEl.classList.remove('text-success');
            priceEl.classList.add('text-danger');
            setTimeout(() => {
                priceEl.classList.remove('text-danger');
                priceEl.classList.add('text-success');
            }, 300);
        }
    }
</script>
</body>
</html>

