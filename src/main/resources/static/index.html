<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auction Real-time Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .bid-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            animation: flash 1s;
        }
        @keyframes flash {
            0% { background-color: #e8f5e9; }
            100% { background-color: transparent; }
        }
        .container { max-width: 800px; margin-top: 30px; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">Auction System Test</h2>

    <!-- User Settings -->
    <div class="card mb-4">
        <div class="card-header">User Settings</div>
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="userId" class="col-form-label">User ID:</label>
                </div>
                <div class="col-auto">
                    <input type="number" id="userId" class="form-control" value="100">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="updateUserInfo()">Set User</button>
                </div>
                <div class="col-auto">
                    <span id="userPointInfo" class="badge bg-info text-dark">Point: 0</span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-secondary" onclick="chargePoint()">Charge 1M</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auction Create (Seller) -->
    <div class="card mb-4">
        <div class="card-header">Create Auction (Seller Mode)</div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" id="auctionTitle" class="form-control" placeholder="Title" value="My Item">
                </div>
                <div class="col-md-3">
                    <input type="number" id="startPrice" class="form-control" placeholder="Start Price" value="1000">
                </div>
                <div class="col-md-3">
                    <input type="number" id="duration" class="form-control" placeholder="Duration (min)" value="5">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="createAuction()">Create</button>
                </div>
            </div>
            <div id="createResult" class="mt-2 text-success"></div>
        </div>
    </div>

    <!-- Auction Interaction -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Auction Room</span>
            <span id="status" class="badge bg-secondary">Disconnected</span>
        </div>
        <div class="card-body">
            <div class="input-group mb-3">
                <span class="input-group-text">Auction ID</span>
                <input type="number" id="targetAuctionId" class="form-control" value="1">
                <button class="btn btn-outline-primary" id="connectBtn" onclick="connect()">Connect</button>
                <button class="btn btn-outline-danger" id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            </div>

            <div class="text-center mb-4">
                <h1 id="currentPrice" class="display-4 text-success">0 KRW</h1>
                <p class="text-muted" id="auctionStatusText">Waiting...</p>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-md-9">
                    <input type="number" id="bidAmount" class="form-control" placeholder="Bid Amount">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-danger w-100" onclick="placeBid()">Place Bid</button>
                </div>
            </div>

            <!-- Admin Controls -->
            <div class="mb-3 border-top pt-2">
                <small class="text-muted">Admin Controls:</small>
                <button class="btn btn-sm btn-outline-success ms-2" onclick="adminApprove()">Approve</button>
                <button class="btn btn-sm btn-outline-warning" onclick="adminStart()">Force Start</button>
                <button class="btn btn-sm btn-outline-danger" onclick="adminEnd()">Force End</button>
            </div>

            <div id="messages" class="border rounded p-3" style="height: 300px; overflow-y: auto; background: #f8f9fa;">
                <!-- Log messages -->
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentUserId = 100;
    let currentAuctionId = 1;
    let currentMaxPrice = 0;

    function updateUserInfo() {
        currentUserId = document.getElementById('userId').value;
        fetchPoint();
    }

    function fetchPoint() {
        fetch('/api/v1/users/points/me', {
            headers: { 'X-User-Id': currentUserId }
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const p = data.data;
                document.getElementById('userPointInfo').textContent = 
                    `Total: ${p.totalPoint.toLocaleString()} / Avail: ${p.availablePoint.toLocaleString()}`;
            }
        });
    }

    function chargePoint() {
        fetch('/api/v1/users/points/charge', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-User-Id': currentUserId 
            },
            body: JSON.stringify({ amount: 1000000 })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) fetchPoint();
            else alert('Charge failed: ' + data.error.message);
        });
    }

    function createAuction() {
        const title = document.getElementById('auctionTitle').value;
        const startPrice = document.getElementById('startPrice').value;
        const duration = document.getElementById('duration').value;
        
        const startTime = new Date();
        startTime.setMinutes(startTime.getMinutes() + 1); // 1분 뒤 시작
        const endTime = new Date(startTime);
        endTime.setMinutes(endTime.getMinutes() + parseInt(duration));

        fetch('/api/v1/seller/auctions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-Id': currentUserId
            },
            body: JSON.stringify({
                title: title,
                startPrice: parseInt(startPrice),
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString()
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('createResult').textContent = `Auction Created! ID: ${data.data}`;
                document.getElementById('targetAuctionId').value = data.data;
            } else {
                alert('Create failed: ' + data.error.message);
            }
        });
    }

    function adminApprove() {
        const id = document.getElementById('targetAuctionId').value;
        fetch(`/api/v1/admin/auctions/${id}/approve`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' }
        }).then(res => {
            if(res.ok) logMessage("System", "Auction Approved by Admin");
            else alert("Approve failed");
        });
    }
    
    function adminStart() {
        const id = document.getElementById('targetAuctionId').value;
        fetch(`/api/v1/admin/auctions/${id}/start`, { method: 'POST' })
        .then(() => logMessage("System", "Auction Force Started"));
    }

    function adminEnd() {
        const id = document.getElementById('targetAuctionId').value;
        fetch(`/api/v1/admin/auctions/${id}/end`, { method: 'POST' })
        .then(() => logMessage("System", "Auction Force Ended"));
    }

    function placeBid() {
        const amountStr = document.getElementById('bidAmount').value;
        if (!amountStr) {
            alert('Please enter bid amount');
            return;
        }
        const amount = parseInt(amountStr);
        
        fetch(`/api/v1/auctions/${currentAuctionId}/bid`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-Id': currentUserId // 실제로는 body에 userId 포함됨
            },
            body: JSON.stringify({
                userId: parseInt(currentUserId),
                amount: amount
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                logMessage("Me", `Bid placed: ${amount}`);
                fetchPoint(); // 포인트 갱신
            } else {
                alert('Bid failed: ' + data.error.message);
            }
        });
    }

    function connect() {
        currentAuctionId = document.getElementById('targetAuctionId').value;
        const socket = new SockJS('/ws-auction');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // console spam 방지

        stompClient.connect({}, function (frame) {
            setConnected(true);
            logMessage("System", 'Connected to Auction ' + currentAuctionId);
            
            stompClient.subscribe('/topic/auctions/' + currentAuctionId, function (message) {
                const body = JSON.parse(message.body);
                handleMessage(body);
            });
        }, function (error) {
            console.error(error);
            setConnected(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        logMessage("System", "Disconnected");
    }

    function setConnected(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        const status = document.getElementById('status');
        if (connected) {
            status.className = 'badge bg-success';
            status.textContent = 'Connected';
        } else {
            status.className = 'badge bg-secondary';
            status.textContent = 'Disconnected';
        }
    }

    function handleMessage(msg) {
        // 메시지 타입에 따른 처리
        if (msg.type === 'ONGOING' || msg.type === 'AUCTION_STARTED') {
            document.getElementById('auctionStatusText').textContent = "ONGOING";
            updatePrice(msg.startPrice || msg.amount); // startPrice가 있을 수도 있음
            logMessage("System", "Auction Started!");
        } else if (msg.type === 'COMPLETED') {
            document.getElementById('auctionStatusText').textContent = "ENDED (Winner: " + msg.winnerId + ")";
            updatePrice(msg.finalPrice);
            logMessage("System", `Auction Ended. Winner: ${msg.winnerId}, Price: ${msg.finalPrice}`);
        } else if (msg.type === 'FAILED') {
            document.getElementById('auctionStatusText').textContent = "FAILED";
            logMessage("System", "Auction Failed (No Bids)");
        } else if (msg.amount) {
            updatePrice(msg.amount);
            logMessage(`User ${msg.userId}`, `${msg.amount.toLocaleString()} KRW`);
        } else {
            console.log("Unknown message:", msg);
        }
    }

    function updatePrice(price) {
        if (!price) return;
        if (price > currentMaxPrice) {
            currentMaxPrice = price;
            const el = document.getElementById('currentPrice');
            el.textContent = price.toLocaleString() + ' KRW';
            el.classList.remove('text-success');
            el.classList.add('text-danger');
            setTimeout(() => {
                el.classList.remove('text-danger');
                el.classList.add('text-success');
            }, 300);
        }
    }

    function logMessage(sender, text) {
        const messages = document.getElementById('messages');
        const item = document.createElement('div');
        item.className = 'bid-item d-flex justify-content-between';
        item.innerHTML = `<strong>${sender}</strong> <span>${text}</span>`;
        messages.prepend(item);
    }

    // Init
    fetchPoint();
</script>
</body>
</html>
