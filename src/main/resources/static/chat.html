<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auction Chat Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2>Auction 1:1 Chat Test</h2>
    
    <!-- 설정 영역 -->
    <div class="card mb-3">
        <div class="card-header">Settings</div>
        <div class="card-body">
            <div class="mb-3">
                <label for="jwtToken" class="form-label">JWT Access Token (Bearer 제외)</label>
                <input type="text" class="form-control" id="jwtToken" placeholder="Enter your JWT access token">
            </div>
            <div class="mb-3">
                <label for="auctionId" class="form-label">Auction ID</label>
                <input type="number" class="form-control" id="auctionId" value="1">
            </div>
            <button id="connectBtn" class="btn btn-primary" onclick="connect()">Enter Chat Room</button>
            <button id="disconnectBtn" class="btn btn-danger" onclick="disconnect()" disabled>Leave</button>
        </div>
    </div>

    <!-- 채팅 영역 -->
    <div id="chatArea" style="display: none;">
        <div class="card">
            <div class="card-header">
                Chat Room <span id="roomIdDisplay" class="badge bg-secondary"></span>
            </div>
            <div class="card-body">
                <div id="messages" style="height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px;">
                    <!-- Messages will appear here -->
                </div>
                
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Type a message...">
                    <button class="btn btn-success" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;
    let currentUserId = null; // View 처리를 위해 필요할 수 있음 (내 메시지 구분용)

    function connect() {
        const token = document.getElementById('jwtToken').value;
        const auctionId = document.getElementById('auctionId').value;

        if (!token) {
            alert("Please enter JWT Token");
            return;
        }

        // 1. 채팅방 입장 API 호출
        fetch(`/api/v1/chat/rooms?auctionId=${auctionId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const roomInfo = data.data;
                currentRoomId = roomInfo.roomId;
                
                // 내 ID 추출 (JWT 파싱)
                const payload = parseJwt(token);
                // payload.sub는 email이므로 ID를 알 수 없음. 
                // UI에서 '나'/'상대방' 구분을 위해선 ID가 필요하지만, 
                // 여기서는 서버 응답(roomInfo)의 sellerId/buyerId와 비교하거나,
                // 일단 ID를 몰라도 전송은 가능하므로 넘어감.
                // (서버가 Principal로 senderId를 결정함)

                document.getElementById('roomIdDisplay').innerText = currentRoomId;
                document.getElementById('chatArea').style.display = 'block';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                connectWebSocket(token);
                loadPreviousMessages(token);
            } else {
                alert("Failed to enter chat room: " + (data.error ? data.error.message : "Unknown error"));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error connecting to chat room");
        });
    }

    function connectWebSocket(token) {
        const socket = new SockJS('/ws-auction');
        stompClient = Stomp.over(socket);

        // 헤더에 Authorization 포함
        stompClient.connect({ 'Authorization': `Bearer ${token}` }, function (frame) {
            console.log('Connected: ' + frame);

            // 구독
            stompClient.subscribe(`/topic/chat/${currentRoomId}`, function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });

        }, function(error) {
             console.error('WebSocket error:', error);
             alert('WebSocket connection failed');
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        document.getElementById('chatArea').style.display = 'none';
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('messages').innerHTML = '';
        console.log("Disconnected");
    }

    function sendMessage() {
        const messageContent = document.getElementById('messageInput').value;
        if(messageContent && stompClient) {
            const chatMessage = {
                roomId: currentRoomId,
                // senderId는 서버에서 Principal로 결정하므로 0이나 null 보내도 됨
                // 하지만 DTO validation이 있을 수 있으므로 아무 값이나 보냄
                senderId: 0, 
                message: messageContent
            };
            stompClient.send("/app/chat/send", {}, JSON.stringify(chatMessage));
            document.getElementById('messageInput').value = '';
        }
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        
        // 내 메시지 구분은 여기서 정확히 할 수 없음 (userId를 모르므로)
        // 일단 모두 왼쪽 정렬
        const isMine = false; 
        messageElement.style.textAlign = isMine ? 'right' : 'left';
        messageElement.style.margin = '5px';
        
        const content = `
            <div style="display: inline-block; padding: 8px 12px; border-radius: 15px; background-color: ${isMine ? '#007bff' : '#e9ecef'}; color: ${isMine ? 'white' : 'black'};">
                <small style="display:block; font-size:0.7em; opacity:0.8;">User ${message.senderId}</small>
                ${message.message}
                <small style="display:block; font-size:0.7em; opacity:0.8;">${new Date(message.timestamp).toLocaleTimeString()}</small>
            </div>
        `;
        
        messageElement.innerHTML = content;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function loadPreviousMessages(token) {
        fetch(`/api/v1/chat/rooms/${currentRoomId}/messages`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const messages = data.data.content;
                messages.forEach(msg => showMessage(msg));
            }
        });
    }
    
    function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }
</script>
</body>
</html>
