name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_IMAGE_PREFIX: ${{ secrets.DOCKER_USERNAME }}/auction

jobs:
  test-and-build:
    name: Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Run tests
        run: ./gradlew clean test
      
      - name: Build with Gradle
        run: ./gradlew build -x test
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/build/test-results/test/**/*.xml
            **/build/reports/tests/test/**
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/build/libs/*.jar

  docker-build-push:
    name: Docker Build & Push
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        service:
          - server-discovery
          - server-gateway
          - user-service
          - auction-service
          - payment-service
          - search-service
          - chat-service
          - admin-service
          - product-service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(grep "version = " build.gradle.kts | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
      
      - name: Build and Push Docker image with Jib
        run: |
          # ì„œë¹„ìŠ¤ ì´ë¦„ì—ì„œ 'server-'ì™€ 'service-' ì ‘ë‘ì‚¬ ì œê±°
          SERVICE_NAME=${{ matrix.service }}
          IMAGE_NAME=${SERVICE_NAME#server-}
          IMAGE_NAME=${IMAGE_NAME#service-}
          
          ./gradlew :${{ matrix.service }}:jib \
            -Djib.to.image=${{ env.DOCKER_IMAGE_PREFIX }}-${IMAGE_NAME}:${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }} \
            -Djib.to.tags=latest
      
      - name: Image digest
        run: |
          SERVICE_NAME=${{ matrix.service }}
          IMAGE_NAME=${SERVICE_NAME#server-}
          IMAGE_NAME=${IMAGE_NAME#service-}
          echo "Image pushed: ${{ env.DOCKER_IMAGE_PREFIX }}-${IMAGE_NAME}:${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}"
          echo "Image pushed: ${{ env.DOCKER_IMAGE_PREFIX }}-${IMAGE_NAME}:latest"

  docker-build-frontend:
    name: Docker Build & Push Frontend
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(grep "version = " build.gradle.kts | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
      
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-frontend:${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}
            ${{ env.DOCKER_IMAGE_PREFIX }}-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Server
    needs: [docker-build-push, docker-build-frontend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Check if server is configured
        id: check_server
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Server not configured - deployment will be skipped"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "âœ“ Server configured - proceeding with deployment"
          fi
      
      - name: Checkout code
        if: steps.check_server.outputs.configured == 'true'
        uses: actions/checkout@v4
      
      - name: Setup SSH
        if: steps.check_server.outputs.configured == 'true'
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        if: steps.check_server.outputs.configured == 'true'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Copy docker-compose.prod.yml to server
        if: steps.check_server.outputs.configured == 'true'
        run: |
          scp docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/auction/
      
      - name: Deploy to server
        if: steps.check_server.outputs.configured == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ~/auction
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ðŸ“¦ Pulling latest images..."
            docker compose -f docker-compose.prod.yml pull
            
            # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ (ë¬´ì¤‘ë‹¨ ë°°í¬)
            echo "ðŸ”„ Restarting services..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af
            
            echo "âœ… Deployment completed!"
          EOF
      
      - name: Health Check
        if: steps.check_server.outputs.configured == 'true'
        run: |
          echo "ðŸ¥ Performing health check..."
          sleep 30
          
          # Gateway í—¬ìŠ¤ì²´í¬
          for i in {1..5}; do
            if curl -f http://${{ secrets.SERVER_HOST }}:8000/actuator/health; then
              echo "âœ… Gateway is healthy"
              exit 0
            fi
            echo "â³ Waiting for services to start... ($i/5)"
            sleep 10
          done
          
          echo "âŒ Health check failed"
          exit 1
      
      - name: Rollback on failure
        if: failure() && steps.check_server.outputs.configured == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ~/auction
            echo "âš ï¸ Deployment failed, rolling back..."
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d
          EOF

  notify:
    name: Notify Deployment
    needs: 
      - test-and-build
      - docker-build-push
      - docker-build-frontend
      - deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.test-and-build.result }}" != "success" ]; then
            echo "âŒ Test & Build failed!"
            exit 1
          fi
          
          # docker-build-pushì™€ docker-build-frontendëŠ” main ë¸Œëžœì¹˜ì—ì„œë§Œ ì‹¤í–‰
          DOCKER_BUILD_RESULT="${{ needs.docker-build-push.result }}"
          FRONTEND_BUILD_RESULT="${{ needs.docker-build-frontend.result }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          
          if [ "$DOCKER_BUILD_RESULT" = "failure" ] || [ "$FRONTEND_BUILD_RESULT" = "failure" ]; then
            echo "âŒ Docker build failed!"
            exit 1
          fi
          
          if [ "$DEPLOY_RESULT" = "failure" ]; then
            echo "âŒ Deployment to server failed!"
            exit 1
          fi
          
          if [ "$DOCKER_BUILD_RESULT" = "success" ] && [ "$FRONTEND_BUILD_RESULT" = "success" ] && [ "$DEPLOY_RESULT" = "success" ]; then
            echo "âœ… Full CI/CD pipeline successful!"
            echo "ðŸš€ Services deployed to production server!"
          elif [ "$DOCKER_BUILD_RESULT" = "success" ] && [ "$FRONTEND_BUILD_RESULT" = "success" ]; then
            echo "âœ… Docker images built and pushed to Docker Hub!"
            echo "â„¹ï¸  Server deployment skipped (SERVER_HOST not configured)"
            echo ""
            echo "ðŸ“ To enable automatic deployment:"
            echo "   1. Set up a server (Ubuntu 22.04 + Docker)"
            echo "   2. Add GitHub Secrets: SERVER_HOST, SERVER_USER, SSH_PRIVATE_KEY"
            echo "   3. Push to main branch again"
          elif [ "$DOCKER_BUILD_RESULT" = "skipped" ] && [ "$FRONTEND_BUILD_RESULT" = "skipped" ]; then
            echo "âœ… Test & Build successful (PR or non-main branch)!"
          else
            echo "âš ï¸ Partial success: Docker=$DOCKER_BUILD_RESULT, Frontend=$FRONTEND_BUILD_RESULT, Deploy=$DEPLOY_RESULT"
          fi
