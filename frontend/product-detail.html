<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ìƒì„¸ - ê²½ë§¤ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .main-image {
            width: 100%;
            height: 500px;
            object-fit: contain;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .thumbnail:hover {
            border-color: #0d6efd;
        }
        
        .thumbnail.active {
            border-color: #0d6efd;
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">ğŸ”¨ ê²½ë§¤ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">í™ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="product-register.html">ìƒí’ˆ ë“±ë¡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="product-list.html">ë‚´ ìƒí’ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="productContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentProduct = null;
        let currentUser = null;

        window.addEventListener('DOMContentLoaded', () => {
            currentUser = getCurrentUser();
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                history.back();
                return;
            }

            loadProduct(productId);
        });

        async function loadProduct(productId) {
            const container = document.getElementById('productContainer');
            
            try {
                const response = await api.get(`/api/v1/products/${productId}`, {
                    headers: {
                        'X-User-Id': currentUser.userId
                    }
                });

                if (response.data.success) {
                    currentProduct = response.data.data;
                    displayProduct(currentProduct);
                } else {
                    throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Load product error:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        function displayProduct(product) {
            const container = document.getElementById('productContainer');
            
            const statusClass = {
                'DRAFT': 'bg-secondary',
                'REGISTERED': 'bg-success',
                'SOLD': 'bg-info',
                'DELETED': 'bg-danger'
            }[product.status] || 'bg-secondary';

            const statusText = {
                'DRAFT': 'ì„ì‹œì €ì¥',
                'REGISTERED': 'ê²½ë§¤ ë“±ë¡ë¨',
                'SOLD': 'íŒë§¤ ì™„ë£Œ',
                'DELETED': 'ì‚­ì œë¨'
            }[product.status] || product.status;

            const conditionText = {
                'NEW': 'ìƒˆ ìƒí’ˆ',
                'USED_GOOD': 'ì¤‘ê³  - ìƒíƒœ ì¢‹ìŒ',
                'USED_BAD': 'ì¤‘ê³  - ì‚¬ìš©ê° ìˆìŒ'
            }[product.condition] || product.condition;

            const categoryText = {
                'ELECTRONICS': 'ì „ìì œí’ˆ',
                'CLOTHING': 'ì˜ë¥˜',
                'BOOKS': 'ë„ì„œ',
                'HOME_APPLIANCES': 'ê°€ì „ì œí’ˆ',
                'SPORTS': 'ìŠ¤í¬ì¸ ',
                'ETC': 'ê¸°íƒ€'
            }[product.category] || product.category;

            const mainImageUrl = product.images && product.images.length > 0
                ? product.images[0].imageUrl
                : 'https://via.placeholder.com/500x500?text=No+Image';

            container.innerHTML = `
                <div class="row">
                    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
                    <div class="col-12 mb-3">
                        <button class="btn btn-outline-secondary" onclick="history.back()">
                            <i class="bi bi-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                        </button>
                    </div>

                    <!-- ì´ë¯¸ì§€ ì„¹ì…˜ -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <img src="${mainImageUrl}" id="mainImage" class="main-image" alt="${product.title}">
                                
                                ${product.images && product.images.length > 1 ? `
                                    <div class="thumbnail-grid">
                                        ${product.images.map((img, index) => `
                                            <img src="${img.imageUrl}" 
                                                 class="thumbnail ${index === 0 ? 'active' : ''}" 
                                                 onclick="changeMainImage('${img.imageUrl}', ${index})"
                                                 alt="Thumbnail ${index + 1}">
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- ì •ë³´ ì„¹ì…˜ -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h2>${product.title}</h2>
                                    <span class="badge ${statusClass} fs-6">${statusText}</span>
                                </div>

                                <div class="mb-4">
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">ì¹´í…Œê³ ë¦¬</div>
                                        <div class="col-8">${categoryText}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">ìƒí’ˆ ìƒíƒœ</div>
                                        <div class="col-8">${conditionText}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-4 text-muted">ë“±ë¡ì¼</div>
                                        <div class="col-8">${new Date(product.createdAt).toLocaleString('ko-KR')}</div>
                                    </div>
                                </div>

                                <hr>

                                <div class="mb-4">
                                    <h5>ìƒí’ˆ ì„¤ëª…</h5>
                                    <p class="text-break" style="white-space: pre-wrap;">${product.description}</p>
                                </div>

                                ${product.status === 'DRAFT' ? `
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary btn-lg" onclick="createAuction()">
                                            <i class="bi bi-arrow-right-circle"></i> ê²½ë§¤ ë“±ë¡í•˜ê¸°
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteProduct()">
                                            <i class="bi bi-trash"></i> ìƒí’ˆ ì‚­ì œ
                                        </button>
                                    </div>
                                ` : product.status === 'REGISTERED' ? `
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> 
                                        ì´ ìƒí’ˆì€ í˜„ì¬ ê²½ë§¤ì— ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeMainImage(imageUrl, index) {
            document.getElementById('mainImage').src = imageUrl;
            
            // ì¸ë„¤ì¼ active í´ë˜ìŠ¤ ë³€ê²½
            document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        function createAuction() {
            window.location.href = `auction-create.html?productId=${currentProduct.id}`;
        }

        async function deleteProduct() {
            if (!confirm('ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await api.delete(`/api/v1/products/${currentProduct.id}`, {
                    headers: {
                        'X-User-Id': currentUser.userId
                    }
                });

                if (response.data.success) {
                    alert('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = 'product-list.html';
                } else {
                    throw new Error('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Delete product error:', error);
                alert(error.response?.data?.error?.message || 'ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>

