<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elasticsearch 동기화 - Auction Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fc;
        }
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link i {
            margin-right: 0.5rem;
        }
        .sidebar-brand {
            color: #fff;
            padding: 1.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block sidebar">
                <div class="sidebar-brand">
                    <i class="fas fa-gavel me-2"></i>Auction Admin
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-fw fa-tachometer-alt"></i>대시보드
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="auction-request.html">
                            <i class="fas fa-fw fa-clipboard-check"></i>경매 승인
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="fas fa-fw fa-users"></i>회원 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="sync-search.html">
                            <i class="fas fa-fw fa-sync"></i>검색 동기화
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link" href="#" onclick="AdminAPI.logout()">
                            <i class="fas fa-fw fa-sign-out-alt"></i>로그아웃
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="fas fa-sync me-2"></i>Elasticsearch 동기화</h1>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-database me-2"></i>검색 데이터 동기화
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    이 기능은 MySQL의 모든 경매 데이터를 Elasticsearch에 동기화합니다.
                                    <ul class="mb-0 mt-2">
                                        <li>기존 인덱스는 모두 삭제됩니다.</li>
                                        <li>현재 가격과 입찰 수는 Redis에서 가져옵니다.</li>
                                        <li>동기화 중에는 검색 기능이 일시적으로 영향을 받을 수 있습니다.</li>
                                    </ul>
                                </div>
                                
                                <button id="syncBtn" class="btn btn-primary btn-lg w-100" onclick="syncSearch()">
                                    <i class="fas fa-sync me-2"></i> 동기화 실행
                                </button>
                                
                                <div id="result" class="mt-4" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-question-circle me-2"></i>동기화 안내
                                </h6>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary"><i class="fas fa-check-circle me-1"></i> 동기화가 필요한 경우</h6>
                                <ul>
                                    <li>검색 결과가 실제 경매 목록과 다를 때</li>
                                    <li>새로운 경매가 검색되지 않을 때</li>
                                    <li>Elasticsearch 장애 복구 후</li>
                                </ul>
                                
                                <h6 class="text-warning mt-3"><i class="fas fa-exclamation-triangle me-1"></i> 주의사항</h6>
                                <ul>
                                    <li>관리자(ROLE_ADMIN) 권한이 필요합니다</li>
                                    <li>데이터가 많을 경우 시간이 소요될 수 있습니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/admin-api.js"></script>
    <script>
        // 페이지 로드 시 권한 확인
        if (!checkAdminRole()) {
            // checkAdminRole()에서 이미 리다이렉트 처리됨
        }

        async function syncSearch() {
            const btn = document.getElementById('syncBtn');
            const result = document.getElementById('result');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>동기화 중...';
            result.style.display = 'none';
            
            try {
                const response = await adminApi.post('/internal/auctions/sync-search');
                
                if (response.data.success) {
                    const data = response.data.data;
                    result.className = 'alert alert-success mt-4';
                    result.innerHTML = `
                        <h5><i class="fas fa-check-circle me-2"></i>동기화 완료!</h5>
                        <p class="mb-0">
                            총 <strong>${data.total}</strong>개의 경매 중 <strong>${data.indexed}</strong>개가 Elasticsearch에 인덱싱되었습니다.
                        </p>
                    `;
                } else {
                    result.className = 'alert alert-danger mt-4';
                    result.innerHTML = `
                        <h5><i class="fas fa-times-circle me-2"></i>동기화 실패</h5>
                        <p class="mb-0">${response.data.error?.message || '알 수 없는 오류'}</p>
                    `;
                }
                result.style.display = 'block';
            } catch (error) {
                let errorMessage = error.message;
                if (error.response?.data?.error) {
                    errorMessage = error.response.data.error.message;
                    if (error.response.data.error.code === 'J007') {
                        errorMessage = '관리자(ROLE_ADMIN) 권한이 필요합니다. 현재 권한: ' + (getCurrentAdmin()?.roles?.join(', ') || '없음');
                    }
                }
                result.className = 'alert alert-danger mt-4';
                result.innerHTML = `
                    <h5><i class="fas fa-times-circle me-2"></i>오류 발생</h5>
                    <p class="mb-0">${errorMessage}</p>
                `;
                result.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync me-2"></i> 동기화 실행';
            }
        }
    </script>
</body>
</html>

