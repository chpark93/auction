<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ë“±ë¡ - ê²½ë§¤ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .image-preview {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            cursor: move;
        }
        
        .image-preview img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 10;
        }
        
        .image-preview .order-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(13, 110, 253, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .upload-area {
            border: 2px dashed #0d6efd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #0b5ed7;
        }
        
        .upload-area.dragover {
            background: #cfe2ff;
            border-color: #0d6efd;
        }
        
        .required-field::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">ğŸ”¨ ê²½ë§¤ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">í™ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="product-register.html">ìƒí’ˆ ë“±ë¡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-box-seam"></i> ìƒí’ˆ ë“±ë¡</h4>
                    </div>
                    <div class="card-body">
                        <form id="productForm">
                            <!-- ìƒí’ˆëª… -->
                            <div class="mb-3">
                                <label for="title" class="form-label required-field">ìƒí’ˆëª…</label>
                                <input type="text" class="form-control" id="title" required 
                                       placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
                                <div class="form-text">ìµœëŒ€ 100ì</div>
                            </div>

                            <!-- ì¹´í…Œê³ ë¦¬ -->
                            <div class="mb-3">
                                <label for="category" class="form-label required-field">ì¹´í…Œê³ ë¦¬</label>
                                <select class="form-select" id="category" required>
                                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                                    <option value="ELECTRONICS">ì „ìì œí’ˆ</option>
                                    <option value="CLOTHING">ì˜ë¥˜</option>
                                    <option value="BOOKS">ë„ì„œ</option>
                                    <option value="HOME_APPLIANCES">ê°€ì „ì œí’ˆ</option>
                                    <option value="SPORTS">ìŠ¤í¬ì¸ </option>
                                    <option value="ETC">ê¸°íƒ€</option>
                                </select>
                            </div>

                            <!-- ìƒí’ˆ ìƒíƒœ -->
                            <div class="mb-3">
                                <label for="condition" class="form-label required-field">ìƒí’ˆ ìƒíƒœ</label>
                                <select class="form-select" id="condition" required>
                                    <option value="">ìƒíƒœ ì„ íƒ</option>
                                    <option value="NEW">ìƒˆ ìƒí’ˆ</option>
                                    <option value="USED_GOOD">ì¤‘ê³  - ìƒíƒœ ì¢‹ìŒ</option>
                                    <option value="USED_BAD">ì¤‘ê³  - ì‚¬ìš©ê° ìˆìŒ</option>
                                </select>
                            </div>

                            <!-- ìƒí’ˆ ì„¤ëª… -->
                            <div class="mb-3">
                                <label for="description" class="form-label required-field">ìƒí’ˆ ì„¤ëª…</label>
                                <textarea class="form-control" id="description" rows="5" required
                                          placeholder="ìƒí’ˆì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="2000"></textarea>
                                <div class="form-text">ìµœëŒ€ 2000ì</div>
                            </div>

                            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                            <div class="mb-4">
                                <label class="form-label required-field">ìƒí’ˆ ì´ë¯¸ì§€</label>
                                <div class="upload-area" id="uploadArea">
                                    <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #0d6efd;"></i>
                                    <p class="mt-2 mb-0">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                                    <p class="text-muted small">ìµœëŒ€ 10ê°œ, JPG/PNG/GIF (ê° 10MB ì´í•˜)</p>
                                    <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                                </div>
                                
                                <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                                <div class="image-preview-container" id="imagePreviewContainer"></div>
                                <div class="form-text mt-2">
                                    <i class="bi bi-info-circle"></i> ì²« ë²ˆì§¸ ì´ë¯¸ì§€ê°€ ëŒ€í‘œ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                </div>
                            </div>

                            <!-- ë²„íŠ¼ -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-check-circle"></i> ìƒí’ˆ ë“±ë¡
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                                    <i class="bi bi-x-circle"></i> ì·¨ì†Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let selectedFiles = [];

        // ë¡œê·¸ì¸ ì²´í¬
        window.addEventListener('DOMContentLoaded', () => {
            const user = getCurrentUser();
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
            }
        });

        // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        // íŒŒì¼ ì„ íƒ
        document.getElementById('imageInput').addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // íŒŒì¼ ì²˜ë¦¬
        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => {
                // ì´ë¯¸ì§€ íŒŒì¼ ì²´í¬
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name}ì€(ëŠ”) ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.`);
                    return false;
                }
                
                // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`${file.name}ì˜ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return false;
                }
                
                return true;
            });

            // ìµœëŒ€ 10ê°œ ì œí•œ
            if (selectedFiles.length + newFiles.length > 10) {
                alert('ìµœëŒ€ 10ê°œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            selectedFiles = selectedFiles.concat(newFiles);
            updateImagePreviews();
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview';
                    previewDiv.draggable = true;
                    previewDiv.dataset.index = index;
                    
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <span class="order-badge">${index + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeImage(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    
                    // ë“œë˜ê·¸ ì´ë²¤íŠ¸
                    previewDiv.addEventListener('dragstart', handleDragStart);
                    previewDiv.addEventListener('dragover', handleDragOver);
                    previewDiv.addEventListener('drop', handleDrop);
                    previewDiv.addEventListener('dragend', handleDragEnd);
                    
                    container.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        }

        // ì´ë¯¸ì§€ ì œê±°
        function removeImage(index) {
            selectedFiles.splice(index, 1);
            updateImagePreviews();
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìˆœì„œ ë³€ê²½
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // ë°°ì—´ ìˆœì„œ ë³€ê²½
                const temp = selectedFiles[draggedIndex];
                selectedFiles[draggedIndex] = selectedFiles[targetIndex];
                selectedFiles[targetIndex] = temp;
                
                updateImagePreviews();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
        }

        // í¼ ì œì¶œ
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFiles.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë“±ë¡ ì¤‘...';

            try {
                const user = getCurrentUser();
                
                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('title', document.getElementById('title').value);
                formData.append('category', document.getElementById('category').value);
                formData.append('condition', document.getElementById('condition').value);
                formData.append('description', document.getElementById('description').value);
                
                // ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€
                selectedFiles.forEach((file, index) => {
                    formData.append('images', file);
                });

                // API í˜¸ì¶œ
                const response = await api.post('/api/v1/products', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        'X-User-Id': user.userId
                    }
                });

                if (response.data.success) {
                    alert('ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.location.href = 'product-list.html';
                } else {
                    throw new Error(response.data.error?.message || 'ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Product registration error:', error);
                alert(error.response?.data?.error?.message || error.message || 'ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> ìƒí’ˆ ë“±ë¡';
            }
        });

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>

