<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë§¤ ë“±ë¡ - ê²½ë§¤ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .product-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">ğŸ”¨ ê²½ë§¤ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">í™ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="product-register.html">ìƒí’ˆ ë“±ë¡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="product-list.html">ë‚´ ìƒí’ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-gavel"></i> ê²½ë§¤ ë“±ë¡</h4>
                    </div>
                    <div class="card-body">
                        <!-- ìƒí’ˆ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="productPreview" class="mb-4">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- ê²½ë§¤ ì„¤ì • í¼ -->
                        <form id="auctionForm">
                            <input type="hidden" id="productId">

                            <div class="mb-3">
                                <label for="startPrice" class="form-label">
                                    ì‹œì‘ ê°€ê²© <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="startPrice" required 
                                           min="1000" step="1000" placeholder="10000">
                                    <span class="input-group-text">ì›</span>
                                </div>
                                <div class="form-text">ìµœì†Œ 1,000ì› ì´ìƒ</div>
                            </div>

                            <div class="mb-3">
                                <label for="startTime" class="form-label">
                                    ê²½ë§¤ ì‹œì‘ ì‹œê°„ <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local" class="form-control" id="startTime" required>
                                <div class="form-text">í˜„ì¬ ì‹œê° ì´í›„ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
                            </div>

                            <div class="mb-4">
                                <label for="endTime" class="form-label">
                                    ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local" class="form-control" id="endTime" required>
                                <div class="form-text">ì‹œì‘ ì‹œê°„ë³´ë‹¤ ìµœì†Œ 1ì‹œê°„ ì´í›„ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                ê²½ë§¤ ë“±ë¡ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìœ¼ë‹ˆ ì‹ ì¤‘í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-check-circle"></i> ê²½ë§¤ ë“±ë¡
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                                    <i class="bi bi-x-circle"></i> ì·¨ì†Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentUser = null;
        let currentProduct = null;

        window.addEventListener('DOMContentLoaded', () => {
            currentUser = getCurrentUser();
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('productId');
            
            if (!productId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                history.back();
                return;
            }

            document.getElementById('productId').value = productId;
            loadProduct(productId);
            setDefaultTimes();
        });

        async function loadProduct(productId) {
            const container = document.getElementById('productPreview');
            
            try {
                const response = await api.get(`/api/v1/products/${productId}`, {
                    headers: {
                        'X-User-Id': currentUser.userId
                    }
                });

                if (response.data.success) {
                    currentProduct = response.data.data;
                    
                    if (currentProduct.status !== 'DRAFT') {
                        alert('ì„ì‹œì €ì¥ ìƒíƒœì˜ ìƒí’ˆë§Œ ê²½ë§¤ì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        history.back();
                        return;
                    }
                    
                    displayProductPreview(currentProduct);
                } else {
                    throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Load product error:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        function displayProductPreview(product) {
            const container = document.getElementById('productPreview');
            const thumbnailUrl = product.images && product.images.length > 0
                ? product.images[0].imageUrl
                : 'https://via.placeholder.com/200x200?text=No+Image';

            container.innerHTML = `
                <div class="product-preview">
                    <h5 class="mb-3">
                        <i class="bi bi-box-seam"></i> ë“±ë¡í•  ìƒí’ˆ
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <img src="${thumbnailUrl}" class="product-image" alt="${product.title}">
                        </div>
                        <div class="col-md-8">
                            <h5>${product.title}</h5>
                            <p class="text-muted mb-2">
                                <i class="bi bi-tag"></i> ${getCategoryName(product.category)} Â· ${getConditionName(product.condition)}
                            </p>
                            <p class="mb-0">${product.description.substring(0, 100)}${product.description.length > 100 ? '...' : ''}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function setDefaultTimes() {
            const now = new Date();
            
            // ì‹œì‘ ì‹œê°„: í˜„ì¬ + 1ì‹œê°„
            const startTime = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('startTime').value = formatDateTimeLocal(startTime);
            document.getElementById('startTime').min = formatDateTimeLocal(now);
            
            // ì¢…ë£Œ ì‹œê°„: ì‹œì‘ + 3ì¼
            const endTime = new Date(startTime.getTime() + 3 * 24 * 60 * 60 * 1000);
            document.getElementById('endTime').value = formatDateTimeLocal(endTime);
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function getCategoryName(category) {
            const names = {
                'ELECTRONICS': 'ì „ìì œí’ˆ',
                'CLOTHING': 'ì˜ë¥˜',
                'BOOKS': 'ë„ì„œ',
                'HOME_APPLIANCES': 'ê°€ì „ì œí’ˆ',
                'SPORTS': 'ìŠ¤í¬ì¸ ',
                'ETC': 'ê¸°íƒ€'
            };
            return names[category] || category;
        }

        function getConditionName(condition) {
            const names = {
                'NEW': 'ìƒˆ ìƒí’ˆ',
                'USED_GOOD': 'ì¤‘ê³  - ìƒíƒœ ì¢‹ìŒ',
                'USED_BAD': 'ì¤‘ê³  - ì‚¬ìš©ê° ìˆìŒ'
            };
            return names[condition] || condition;
        }

        document.getElementById('auctionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const startTime = new Date(document.getElementById('startTime').value);
            const endTime = new Date(document.getElementById('endTime').value);
            const now = new Date();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (startTime < now) {
                alert('ê²½ë§¤ ì‹œì‘ ì‹œê°„ì€ í˜„ì¬ ì‹œê° ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            if (endTime <= startTime) {
                alert('ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const duration = endTime - startTime;
            if (duration < 60 * 60 * 1000) {
                alert('ê²½ë§¤ ê¸°ê°„ì€ ìµœì†Œ 1ì‹œê°„ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë“±ë¡ ì¤‘...';

            try {
                const requestData = {
                    productId: parseInt(document.getElementById('productId').value),
                    startPrice: parseInt(document.getElementById('startPrice').value),
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value
                };

                const response = await api.post('/api/v1/seller/auctions', requestData, {
                    headers: {
                        'X-User-Id': currentUser.userId
                    }
                });

                if (response.data.success) {
                    alert('ê²½ë§¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.location.href = `detail.html?id=${response.data.data}`;
                } else {
                    throw new Error(response.data.error?.message || 'ê²½ë§¤ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Create auction error:', error);
                alert(error.response?.data?.error?.message || error.message || 'ê²½ë§¤ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> ê²½ë§¤ ë“±ë¡';
            }
        });

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>

