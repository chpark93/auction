server:
  port: 8081

spring:
  application:
    name: server-gateway
  data:
    redis:
      host: localhost
      port: 6379
  cloud:
    gateway:
      # Redis Rate Limiter 설정
      redis-rate-limiter:
        replenishRate: 10 # 초당 10개 토큰 충전
        burstCapacity: 20 # 최대 20개 버스트 허용
        requestedTokens: 1 # 요청당 1개 토큰 소비
      server:
        webflux:
          routes:
            # Internal APIs - ROLE_ADMIN only
            # /internal/auctions/sync-search - 관리자 권한 필요
            - id: internal-auction-sync
              uri: lb://SERVICE-AUCTION
              predicates:
                - Path=/internal/auctions/sync-search
                - Method=POST
              filters:
                - RoleCheckFilter=ROLE_ADMIN
            # ⛔️ Internal APIs - Block external access
            # 나머지 /internal/** 경로는 서비스 간 통신 전용으로, 외부에서 접근 불가
            - id: block-internal-apis
              uri: no://op
              predicates:
                - Path=/internal/**
              filters:
                - name: SetStatus
                  args:
                    status: 403
            # Auth Service (Public)
            - id: service-user-public
              uri: lb://SERVICE-USER
              predicates:
                - Path=/api/v1/auth/**
            # User Points (in Payment Service)
            - id: service-payment-points
              uri: lb://SERVICE-PAYMENT
              predicates:
                - Path=/api/v1/users/points/**
              filters:
                - AuthorizationHeaderFilter
            # User Service
            - id: service-user
              uri: lb://SERVICE-USER
              predicates:
                - Path=/api/v1/users/**
              filters:
                - AuthorizationHeaderFilter
            # Auction Service (Public - List)
            - id: service-auction-public
              uri: lb://SERVICE-AUCTION
              predicates:
                - Path=/api/v1/auctions/**
                - Method=GET
            # Auction Service (Seller) - Rate Limit 적용
            - id: service-auction-seller
              uri: lb://SERVICE-AUCTION
              predicates:
                - Path=/api/v1/seller/**
              filters:
                - AuthorizationHeaderFilter
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 10
                    redis-rate-limiter.burstCapacity: 20
                    key-resolver: "#{@userKeyResolver}"
            # Auction Service (Bid) - Rate Limit 적용
            - id: service-auction-bid
              uri: lb://SERVICE-AUCTION
              predicates:
                - Path=/api/v1/auctions/**
                - Method=POST,PUT,DELETE
              filters:
                - AuthorizationHeaderFilter
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 5    # 입찰은 더 엄격하게 (초당 5개)
                    redis-rate-limiter.burstCapacity: 10   # 최대 10개
                    redis-rate-limiter.requestedTokens: 1
                    key-resolver: "#{@userKeyResolver}"    # 사용자 기반 제한
                    deny-empty-key: false                  # 키가 없어도 허용 (IP로 fallback)
            # Admin Service
            - id: service-admin
              uri: lb://SERVICE-ADMIN
              predicates:
                - Path=/api/v1/admin/**
              filters:
                - AuthorizationHeaderFilter
            # Auction WebSocket
            - id: service-auction-ws
              uri: lb://SERVICE-AUCTION
              predicates:
                - Path=/ws-auction/**
            # Payment Service
            - id: service-payment
              uri: lb://SERVICE-PAYMENT
              predicates:
                - Path=/api/v1/payments/**
              filters:
                - AuthorizationHeaderFilter
            # Search Service - Rate Limit 적용
            - id: service-search
              uri: lb://SERVICE-SEARCH
              predicates:
                - Path=/api/v1/search/**
              filters:
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 20   # 검색은 더 여유롭게
                    redis-rate-limiter.burstCapacity: 50
                    key-resolver: "#{@ipKeyResolver}"      # 로그인 없이도 사용 가능하므로 IP 기반
            # Chat Service
            - id: service-chat-api
              uri: lb://SERVICE-CHAT
              predicates:
                - Path=/api/v1/chat/**
              filters:
                - AuthorizationHeaderFilter
            # Chat WebSocket
            - id: service-chat-ws
              uri: lb://SERVICE-CHAT
              predicates:
                - Path=/ws-chat/**
            # Swagger UI Routes for each service
            - id: service-admin-swagger
              uri: lb://SERVICE-ADMIN
              predicates:
                - Path=/service-admin/v3/api-docs
              filters:
                - RewritePath=/service-admin/v3/api-docs, /v3/api-docs
            - id: service-user-swagger
              uri: lb://SERVICE-USER
              predicates:
                - Path=/service-user/v3/api-docs
              filters:
                - RewritePath=/service-user/v3/api-docs, /v3/api-docs
            - id: service-auction-swagger
              uri: lb://SERVICE-AUCTION
              predicates:
                - Path=/service-auction/v3/api-docs
              filters:
                - RewritePath=/service-auction/v3/api-docs, /v3/api-docs
            - id: service-payment-swagger
              uri: lb://SERVICE-PAYMENT
              predicates:
                - Path=/service-payment/v3/api-docs
              filters:
                - RewritePath=/service-payment/v3/api-docs, /v3/api-docs
            - id: service-search-swagger
              uri: lb://SERVICE-SEARCH
              predicates:
                - Path=/service-search/v3/api-docs
              filters:
                - RewritePath=/service-search/v3/api-docs, /v3/api-docs
            - id: service-chat-swagger
              uri: lb://SERVICE-CHAT
              predicates:
                - Path=/service-chat/v3/api-docs
              filters:
                - RewritePath=/service-chat/v3/api-docs, /v3/api-docs

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/

jwt:
  secret: c2VjcmV0LWtleS1mb3ItYXVjdGlvbi1wcm9qZWN0LXRlc3QtMTIzNDU2Nzg5MA==
  issuer: auction-service
  access-token-ttl: 1800000
  refresh-token-ttl: 604800000

springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: Admin Service (BFF)
        url: /service-admin/v3/api-docs
      - name: User Service
        url: /service-user/v3/api-docs
      - name: Auction Service
        url: /service-auction/v3/api-docs
      - name: Payment Service
        url: /service-payment/v3/api-docs
      - name: Search Service
        url: /service-search/v3/api-docs
      - name: Chat Service
        url: /service-chat/v3/api-docs

management:
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans

logging:
  pattern:
    level: "%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]"
